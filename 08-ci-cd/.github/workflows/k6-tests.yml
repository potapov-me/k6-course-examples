# –£—Ä–æ–∫ 9: GitHub Actions –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
# –ó–∞–ø—É—Å–∫ k6 —Ç–µ—Å—Ç–æ–≤ –≤ GitHub Actions

name: k6 Load Tests

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  schedule:
    # Nightly load test –≤ 3:00 UTC –ø–æ –±—É–¥–Ω—è–º
    - cron: "0 3 * * 1-5"
  workflow_dispatch:

jobs:
  # Smoke-—Ç–µ—Å—Ç –Ω–∞ –∫–∞–∂–¥–æ–º PR
  smoke-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Run k6 smoke test
        uses: grafana/k6-action@v0.3.1
        with:
          filename: tests/smoke.js
          flags: --vus 3 --duration 2m --summary-export summary.json
        env:
          BASE_URL: ${{ secrets.STAGING_URL }}

      - name: Upload summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-summary
          path: summary.json
          retention-days: 7

  # Load-—Ç–µ—Å—Ç –Ω–∞ main –∏–ª–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
  load-test:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - name: Run k6 load test
        uses: grafana/k6-action@v0.3.1
        with:
          filename: tests/load.js
          flags: --summary-export summary.json --out json=raw.json
        env:
          BASE_URL: ${{ secrets.STAGING_URL }}
          TEST_TOKEN: ${{ secrets.TEST_TOKEN }}

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: |
            summary.json
            raw.json
          retention-days: 30

  # –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å baseline
  compare-baseline:
    runs-on: ubuntu-latest
    needs: load-test
    steps:
      - uses: actions/checkout@v4

      - name: Download load test results
        uses: actions/download-artifact@v4
        with:
          name: load-test-results

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Compare with baseline
        run: |
          # TODO: –°–∫–∞—á–∞—Ç—å baseline –∏–∑ S3/GCS
          # aws s3 cp s3://your-bucket/baseline.json baseline.json

          node scripts/compare-baseline.js summary.json baseline.json 0.1

          # TODO: –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π baseline
          # aws s3 cp summary.json s3://your-bucket/baseline.json

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('summary.json', 'utf8'));

            const comment = `## üìä Load Test Results

            - **p95 latency**: ${summary.metrics.http_req_duration.values['p(95)'].toFixed(0)}ms
            - **p99 latency**: ${summary.metrics.http_req_duration.values['p(99)'].toFixed(0)}ms
            - **Error rate**: ${(summary.metrics.http_req_failed.values.rate * 100).toFixed(2)}%
            - **Checks**: ${(summary.metrics.checks.values.rate * 100).toFixed(1)}%
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
