# Урок 9: GitLab CI интеграция
# Запуск k6 тестов в GitLab CI/CD pipeline

stages:
  - test
  - load
  - compare

variables:
  K6_IMAGE: grafana/k6:latest
  BASE_URL: https://staging.yourapp.com

# Smoke-тест на каждом PR
smoke-test:
  stage: test
  image: $K6_IMAGE
  script:
    - k6 run tests/smoke.js --vus 3 --duration 2m --summary-export summary.json
  artifacts:
    when: always
    paths:
      - summary.json
    expire_in: 7 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# Load-тест на main branch
load-test:
  stage: load
  image: $K6_IMAGE
  script:
    - k6 run tests/load.js --summary-export summary.json --out json=raw.json
  artifacts:
    when: always
    paths:
      - summary.json
      - raw.json
    expire_in: 30 days
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# Сравнение с baseline
compare-baseline:
  stage: compare
  image: node:18
  needs:
    - load-test
  script:
    # Скачиваем baseline из S3/GCS
    - echo "Fetching baseline..."
    # - aws s3 cp s3://your-bucket/baseline.json baseline.json

    # Сравниваем
    - node scripts/compare-baseline.js summary.json baseline.json 0.1

    # Если Ok — обновляем baseline
    - echo "Uploading new baseline..."
    # - aws s3 cp summary.json s3://your-bucket/baseline.json
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# Nightly stress test
stress-test:
  stage: load
  image: $K6_IMAGE
  script:
    - k6 run tests/stress.js --summary-export stress-summary.json
  artifacts:
    when: always
    paths:
      - stress-summary.json
    expire_in: 30 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
  allow_failure: true  # Stress-тест может упасть — это нормально
